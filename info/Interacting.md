# Interacting with the REST API

* [Certificates](#certificates)
* [Makefile Comparsion Testing](#makefile-comparison-testing)
* [From a Web Browser](#from-a-web-browser)
* [REST API Documentation (OpenAPI)](#rest-api-documentation-openapi)
* [Using cURL](*using-curl)
* [Using OpenSSL's s_client](#using-openssl-and-sclient)

## Certificates

NOTE: This assumes that both KME hosts have their respective REST API services fully up and running.

Several certificate and private key pairs are generated on a per docker-compose service level. For each KME host, the directory `${TOP_DIR}volumes/${LOCAL_KME_ID}/certificates/production/` will contain all client- and server-based certificate pairs; e.g.:
```bash
bob@qtpi-2:~/code/guardian$ ls volumes/kme2/certificates/production/
admin  rest  sae2  vault  vault_init  watcher
```

Each directory will at least contain a Certificate Authority (CA) chain certificate PEM-encoded file as well as its corresponding private key PEM-encoded file; e.g.:
```bash
bob@qtpi-2:~/code/guardian$ tree volumes/kme2/certificates/production/sae2
volumes/kme2/certificates/production/sae2
├── sae2.ca-chain.cert.pem
└── sae2.key.pem
```

The CA-chain file contains the certificate as well as the certificates of the issuing CAs all the way back to the Root CA in descending order. In other words, the client/server certificate will be at the top of the file, then usually an intermediate CA's certificate, followed by a Root CA's certificate at the bottom.

A local KME server is configured to allow interaction with its remote KME counterpart. This is possible because the respective rest service CA-chain files have been `rsync`ed to the remote KME during startup. Additionally, each KME is configured to allow interaction with its respective local SAE. In the above example, `sae2` may interact with `kme2`. Similarly `sae1` may interact with `kme1`.

The `admin` directory contains copies of the certificate and private key files in a world-readable file mode. This is for convenience and is not necessary for production. Additionally, PKCS #12 (.p12) files that contain both the CA-chain and private key information have been generated to more easily interact with web browsers which tend to more readily handle this certificate file format; e.g.
```bash
bob@qtpi-2:~/code/guardian$ ls -l volumes/kme2/certificates/production/admin/sae2
total 20
-rw-r--r-- 1 root root 6671 Jun  8 03:45 sae2.ca-chain.cert.pem
-r--r--r-- 1 root root 1674 Jun  8 03:45 sae2.key.pem
-rw-r--r-- 1 root root 6600 Jun  8 03:45 sae2.p12
```

The above cert.pem and key.pem files are identical to the ones in the `production/sae2` directory besides file permissions.

NOTE: For developers, the primary certificate pairs to utilize are `sae1` and `sae2`. Also note that intermediate certificate authorities exist within each Vault instance that can generate new certificate/private key pairs as well as sign any Certificate Signing Requests (CSRs) generated by SAE hosts.

## Makefile Comparison Testing

From the KME1 host or from a host that has passwordless SSH to both KME1 and KME2 hosts, it is possible to issue a `make compare` to utilize the `sae1` and `sae2` certificates; e.g.:
```bash
alice@qtpi-1:~/code/guardian$ make compare

Using Local KME configuration: 'kme1'
Use the command-line syntax, e.g. 'KME=kme2' to change

Remote KME Repository Location: 'bob@kme2:/home/bob/code/guardian'
Use the command-line syntax, e.g. 'REMOTE_KME_DIRPATH=alice@kme1:/home/alice/code/guardian' to change

Environment variables used throughout Guardian:
KME: kme1
LOCAL_KME_ID: kme1
REMOTE_KME_ID: kme2
LOCAL_SAE_ID: sae1
REMOTE_SAE_ID: sae2

./scripts/compare.sh
receiving incremental file list

sent 25 bytes  received 136 bytes  64.40 bytes/sec
total size is 14,945  speedup is 92.83
receiving incremental file list

sent 25 bytes  received 132 bytes  62.80 bytes/sec
total size is 14,949  speedup is 95.22
1 key; 8 bits each; 4 iterations
1: Key IDs match! Keys match! PASS
2: Key IDs match! Keys match! PASS
...
4 keys; 8 bits each; 4 iterations
...
1 key; 256 bits each; 4 iterations
...
4 keys; 256 bits each; 4 iterations
4 simultaneous requests; 1 key; 8 bits each; 4 iterations
1: 1: 1: 1: Key IDs match! Keys match! PASS
2: Key IDs match! Keys match! PASS
2: Key IDs match! Key IDs match! Keys match! Keys match! PASS
...
Key IDs match! Keys match! PASS
```

SAE host certificates are `rsync`ed to the local host's `/tmp/guardian_test` directory and several tests are conducted from the ${TOP_DIR}/scripts/compare.sh script.

The compare script in turn calls the key_loop.sh script which takes the number of requested keys, the size of the requested keys in bits, and the number of sequential iterations to perform.

Various synchronous and asynchronous tests are conducted on small to modest size key requests.

NOTE: This test consumes keying material. If the KME runs out of keying material, this test will begin to fail in a seemingly sporadic fashion until all tests eventually fail. This is related to how keying material is reserved and consumed on the Vault back end and is to be expected.

NOTE: It is possible for Vault instances to become out of sync. This can lead to comparison failures. The most straightforward way to re-sync is to first `make clear` on both KME hosts to clear out the Vault instances. From there, issue more keys via `make keys` on the KME1 host and then subsequently on the KME2 host. Afterwards, `make compare` tests should be passing.

## From a Web Browser

Web browsers have certificate databases which hold trusted certificates. I will demonstrate purely using a browser's user interface and also by using command-line tools called `certutil` and `pk12util`. I find the command-line option to be faster and more reliable but I tend to iterate testing from scratch which may not be how most readers interact.

Do watch out for caching effects. Browsers tend to hold onto information in seemingly unpredictable ways that even a full browser restart may not alleviate. Private sandboxes and/or incognito modes can help as well.

NOTE: This can be carried out from any host that can access the KME hosts (e.g. my laptop). I find it convenient to also set up name resolution in /etc/hosts as explained in [Prerequisites](Prerequisites.md) for my laptop host as well.

NOTE: You will need to remotely copy (at minimum) the corresponding PKCS #12 (.p12) certificate file you wish to utilize to the host you wish to use the web browser on. Recommendations for transfer include SSH or SFTP protocols via scp, rsync, or sftp commands.

### Firefox Setup

#### UI Method

1. In the URL bar, navigate to `about:preferences
1. In the `Find in Preferences` search bar, type in `certificates` and click `View Certificates
1. Go to `Your Certificates` tab; click `Import` and navigate to the .p12 file you wish to import ![Load .p12](figures/firefox_load_p12.png)
1. There should be no password on guardian-generated .p12 files, so click `OK` ![No Password](figures/firefox_no_passwd.png)
1. If the import was successful, the .p12 file should show up in your list of certificates. Check file permissions to ensure readability if you are having issues. ![Import Successful](figures/firefox_p12_loaded.png)
1. Navigate to the `Authorities` tab. Scroll down and verify the name of your Root Certificate Authority (Quantum Internet Technologies LLC, by default). ![CA is Present](figures/firefox_added_ca.png)
1. Additionally, you may opt to trust the Root CA for use in identifying websites ![Trust CA](figures/firefox_trust_ca.png)
1. Click `OK` for the Certificate Manager and close the `Preferences` tab.
1. To remove certificates, follow the same procedure but use the `Delete or Distrust` button instead of `Import`. Be sure to remove not only the added certificate but also the Certificate Authorities as well. Also note the certificate may be cached. Tab hard refreshes (CONTROL+R/F5) and/or browser restarts can sometimes coax a certificate refresh.

#### Command-line Method

An equivalent method to the above UI Method involves using `certutil` and `pk12util`. On Fedora, the command `dnf whatprovides */certutil` shows it comes from the `nss-tools` RPM. On Ubuntu, `apt search certutil` shows it comes from `libnss3-tools`.

1. Find the Firefox Profile directory associated with your user account. Most often on a Linux system, it lives at `~/.mozilla/firefox/<random-string>.default/`. Usually, it is a `cert9.db` file under this directory that is housing the certificates. cert8.db files are older but possible. In essence, the file is an SQLite database. 
1. Query the directory with the `certutil` to see what certificates are present:
```bash
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

DigiCert SHA2 Secure Server CA                               ,,   
...
kme1_sae1                                                    u,u,u
kme1_CA                                                      ,,   
Quantum Internet Technologies LLC Root CA kme1 - Quantum Internet Technologies LLC ,,   
```
1. To clear any residual certificates, use `-D` along with `-n`; see man pages for more:
```bash
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -D -n kme1_sae1
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -D -n kme1_CA
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -D -n "Quantum Internet Technologies LLC Root CA kme1 - Quantum Internet Technologies LLC"
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

DigiCert SHA2 Secure Server CA                               ,,
...
```
1. To add a new .p12 file, use the `pk12util` command along with the `-d`, `-i`, `-W` options:
```bash
cproctor@spren:guardian_test>pk12util -d ~/.mozilla/firefox/a6y6g3o7.default/ -i /tmp/guardian_test/sae1/sae1.p12 -W ""
pk12util: PKCS12 IMPORT SUCCESSFUL
# Modify the trust attributes of the Root CA
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -M -t "CT,c," -n "Quantum Internet Technologies LLC Root CA kme1 - Quantum Internet Technologies LLC"
cproctor@spren:guardian_test>certutil -d ~/.mozilla/firefox/a6y6g3o7.default/ -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

DigiCert SHA2 Secure Server CA                               ,,
...
kme1_sae1                                                    u,u,u
kme1_CA                                                      ,,
Quantum Internet Technologies LLC Root CA kme1 - Quantum Internet Technologies LLC CT,c,
```

### Chromium Setup

NOTE: This is being tested in a `Chromium` browser (open-source version of Chrome). There may or may not be differences if Chrome is used.

#### UI Method

1. Open a new tab and navigate to `chrome://settings/certificates`
1. Navigate to the `Your Certificates` tab; click `Import` and navigate to the .p12 file you wish to import ![Load .p12](figures/chrome_load_p12.png)
1. There should be no password on guardian-generated .p12 files, so click `OK` ![No Password](figures/chrome_no_passwd.png)
1. If the import was successful, the .p12 file should show up in your list of certificates. Check file permissions to ensure readability if you are having issues. ![Import Successful](figures/chrome_p12_loaded.png)
1. Navigate to the `Authorities` tab. Scroll down and verify the name of your Root Certificate Authority (Quantum Internet Technologies LLC, by default).
1. Additionally, you may opt to trust the Root CA for use in identifying websites ![Trust CA](figures/chrome_trust_ca.png)
1. You may close the chrome settings tab when complete.
1. To remove certificates, follow the same procedure but use the `Delete` drop down option instead of `Import`. Be sure to remove not only the added certificate but also the Certificate Authorities as well. Also note the certificate may be cached. Tab hard refreshes (CONTROL+R/F5) and/or browser restarts can sometimes coax a certificate refresh.

#### Command-line Method

This section is identical to the Firefox command-line section except for the location of the Chrome profile. On Fedora, this is located at `~/.pki/nssdb`. Therefore, all commands will now look like:
```bash
cproctor@spren:~>certutil -d ~/.pki/nssdb/ -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

kme1_sae1                                                    u,u,u
kme1_CA                                                      ,,
Quantum Internet Technologies LLC Root CA kme1 - Quantum Internet Technologies LLC CT,c,c
```

where the `-d` directory option has been updated.

### Certificate Usage

Most public websites do not require a client-side certificate to be presented to the web server. In this particular case, because mutual TLS is being performed, we do need to choose the appropriate client-side certificate to use.

To do this, once you have properly installed via the Web UI or command-line method, you simply navigate to the desired website. The web server will prompt the client web browser for a certificate while also providing its own server-side certificate. In this manual process, you may inspect the server-side certificate. 

A window should pop up prompting you to choose the certificate you wish to provide.

Firefox ![Which Certificate?](figures/firefox_accept_cert.png)

Chrome ![Which Certificate?](figures/chrome_accept_cert.png)

Choose (typically) either the `sae1` or `sae2` certificate depending on whether you are attempting to access a `kme1` or `kme2` webpage respectively.

NOTE: If the Root CA is not Trusted to identify websites, you will see a warning screen. It will alert you that the certificate issued by the web server is untrusted.

Firefox ![Untrusted CA](figures/firefox_ca_warning.png)

Chrome ![Untrusted CA](figures/chrome_ca_warning.png)

You may accept the risk and continue on to the site. You will have a small lock with a yellow/red caution triangle reminding you the connection is not secure/private. TLS is still being used but the browser does not trust the Root CA.

### Traefik Dashboard

With the appropriate client-side certificates installed and Root CAs trusted, you now navigate your web browser to:

https://traefik.kme1

https://traefik.kme2

The http:// version should redirect to the https:// version.

You will see on the main dashboard: ![Traefik Mainpage](figures/traefik_mainpage.png)
All HTTP Routers, Services, and Middlewares are successful and none have warnings or errors.

Entrypoints are configured for ports 80 (http redirecting to 443) and 443 (http with TLS -- https).

No TCP or UDP configurations are currently setup.

Both the `file` and `Docker`  providers are configured and listening.

You may explore other specific configuration options here.

NOTE: I don't view this page as particularly sensitive, but if you do, there are straightforward methods for putting an additional basic HTTP Authenication in front of this web page. Remember, you are already authenticating based on client-side certificates. But, you could configure some type of "admin" access as long as whomever does not have remote SSH access to the KME hosts.

NOTE: More specific details on how Traefik has been configured can be found in the [Traefik Configuration](Traefik.md) file.

### Vault UI

With the appropriate client-side certificates installed and Root CAs trusted, you now navigate your web browser to:

https://kme1:8200

https://kme2:8200

That's host `kme1` or `kme2` with port 8200.

The http:// version will not redirect to the https:// version. Instead, you will receive the message "Client sent an HTTP request to an HTTPS server."

NOTE: The Vault UI is running independent of the Traefik service. Vault is already configured with TLS support. It could be configured to be behind traefik with TLS certificate passthrough, if that is desired.

You will see the login page: ![Vault Login](figures/chrome_vault_login.png)

To login, you need to lookup a generated root token in the file `${TOP_DIR}/volumes/${LOCAL_KME_ID}/certificates/production/admin/vault/SECRETS`. Note that each KME host has its own independent Vault instance with its own root token.

The file will look something like:
```bash
alice@qtpi-1:~/code/guardian$ cat volumes/kme1/certificates/production/admin/vault/SECRETS
{
  "keys": [
    "5bc89f191f515c92af71704f06e639aa361a1ff2468ec19da756ae6bf4bf71aa64",
    "86f05b8749998b2335fcb14565ca8883a65dee1e3336739101f9dae3df04277e34",
    "a48b852fb73c258216ba79d104983182c643eb9eb6fa6fe0a38cd7cf3620c55eef",
    "2856641480d48143920d303a2b903351ff1e8122d39a777306f36a9f28689c85e2",
    "6427713e648a18f961719a02c32c64347394d64d9fd44f335a567e88db74352757"
  ],
  "root_token": "s.O8mUWreHhSi491IRsImuTUSe"
```

NOTE: the above keys and root_token will change any time the Vault instance is remade after a `make clean` or `makeallclean` is issued.

Copy the "root_token" value (the part starting with "s.O8...") and input this into the login page.

The Vault mainpage will look something like: ![Vault Mainpage](figures/chrome_vault_mainpage.png)

The `Secrets` Engines tab shows all enabled engines:
* cubbyhole - comes by default and is a local storage space (not used by this setup)
* pki_int - (Vault Type PKI Secrets Engine) Public Key Infrastructure (PKI) Intermediate (Int) is an intermediate Certificate Authority (CA) responsible for generating or signing new certificates
* QKEYS (Vault Type Key Value Version 2 Secrets Engine) is where the QKD key information is being stored and tracked

The `Access` tab shows allowed authentication methods, current entities, and current leases to those entities given a specific authentication method. Everything that is needed is already set up.

The `Policies` tab lists all the Access Control List (ACL) policies that are in the Vault instance. These policies dictate what can be done (or not done) by an entity that logs in with the particular role that uses a specific policy. Policies have been created for the Intermediate CA Certificate Issuer, the REST API, and the Watcher service.

The `tools` tab has various tools that one may find useful if spending a significant amount of time in Vault. Nothing of particular interest for us.

NOTE: More specific details on how Vault has been configured can be found in the [Vault Configuration](Vault.md) file.

### REST API Documentation OpenAPI

With the appropriate client-side certificates installed and Root CAs trusted, you now navigate your web browser to:

https://kme1/docs

https://kme2/docs

The http:// version should redirect to the https:// version.

You will see on the main documents page: ![OpenAPI Mainpage](figures/chrome_openapi_mainpage.png)

This is the primary developer documentation location that provides all relevant information for anyone implementing the SAE client to retrieve keying material. It includes the detailed implementation of all endpoints as well as built-in examples and the schema used in data requests and data responses.

NOTE: More specific details on how the REST API has been configured can be found in the [REST API Configuration](REST.md) file.

## Using cURL

Coming soon. In the meantime, see [key_compare.sh](../scripts/key_compare.sh).

## Using OpenSSL and s_client

Coming soon.
